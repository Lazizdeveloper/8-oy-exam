<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-Shop ‚Äî Tayyor Frontend</title>
  <!-- React + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel (JSX) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Axios (API) -->
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <!-- React Router -->
  <script src="https://unpkg.com/react-router-dom@6/umd/react-router-dom.development.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4f46e5',
            secondary: '#818cf8',
            accent: '#10b981'
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body { margin: 0; font-family: system-ui; background: #f9fafb; }
    .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useContext, createContext } = React;
    const { BrowserRouter, Routes, Route, Link, Navigate, useNavigate, Outlet } = ReactRouterDOM;

    // ========== Config ==========
    const API_BASE = 'http://localhost:3000';

    // ========== Auth Context ==========
    const AuthContext = createContext();

    const AuthProvider = ({ children }) => {
      const [auth, setAuth] = useState(() => {
        const token = localStorage.getItem('accessToken');
        return token ? { token, role: localStorage.getItem('userRole') || 'user' } : null;
      });

      const login = (accessToken, refreshToken, role = 'user') => {
        localStorage.setItem('accessToken', accessToken);
        localStorage.setItem('refreshToken', refreshToken);
        localStorage.setItem('userRole', role);
        setAuth({ token: accessToken, role });
      };

      const logout = () => {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('userRole');
        setAuth(null);
      };

      return <AuthContext.Provider value={{ auth, login, logout }}>{children}</AuthContext.Provider>;
    };

    const useAuth = () => useContext(AuthContext);

    // ========== Layout ==========
    const Layout = () => {
      const { auth, logout } = useAuth();
      return (
        <div className="min-h-screen flex flex-col">
          <header className="bg-white shadow-sm sticky top-0 z-50">
            <div className="container mx-auto px-4 py-3 flex justify-between items-center">
              <Link to="/" className="text-2xl font-bold text-primary">E-Shop</Link>
              <div className="flex items-center space-x-4">
                {auth ? (
                  <>
                    <Link to="/cart" className="relative">
                      <i className="fas fa-shopping-cart text-xl text-gray-700"></i>
                    </Link>
                    {auth.role === 'admin' && (
                      <Link to="/admin" className="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">
                        Admin
                      </Link>
                    )}
                    <button onClick={logout} className="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded">
                      Chiqish
                    </button>
                  </>
                ) : (
                  <div className="space-x-2">
                    <Link to="/login" className="text-sm text-gray-600 hover:text-primary">Kirish</Link>
                    <Link to="/register" className="text-sm bg-primary text-white px-3 py-1 rounded hover:bg-indigo-700">
                      Ro'yxatdan o'tish
                    </Link>
                  </div>
                )}
              </div>
            </div>
          </header>
          <main className="flex-grow py-6">
            <Outlet />
          </main>
          <footer className="bg-gray-800 text-white py-6">
            <div className="container mx-auto px-4 text-center">
              <p>¬© 2025 E-Shop. Barcha huquqlar himoyalangan.</p>
            </div>
          </footer>
        </div>
      );
    };

    // ========== Routes ==========
    const PublicRoute = ({ children }) => {
      const { auth } = useAuth();
      return auth ? <Navigate to="/" /> : children;
    };

    const PrivateRoute = ({ children, adminOnly = false }) => {
      const { auth } = useAuth();
      if (!auth) return <Navigate to="/login" />;
      if (adminOnly && auth.role !== 'admin') return <Navigate to="/" />;
      return children;
    };

    // ========== Pages ==========
    const Home = () => (
      <div className="container mx-auto px-4 py-12 text-center">
        <h1 className="text-4xl md:text-5xl font-bold mb-6 bg-gradient-to-r from-primary to-indigo-600 bg-clip-text text-transparent">
          Sifatli mahsulotlarni uydan chiqmasdan sotib oling!
        </h1>
        <p className="text-lg text-gray-600 mb-8">Eng yaxshi narxlarda elektronika, kiyim-kechak, uy jihozlari.</p>
        <div className="flex justify-center space-x-4">
          <Link to="/products" className="bg-gradient-to-r from-primary to-indigo-600 text-white px-6 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl">
            Mahsulotlarni ko'rish
          </Link>
        </div>
      </div>
    );

    const Register = () => {
      const [form, setForm] = useState({ name: '', email: '', password: '' });
      const [error, setError] = useState('');
      const { login } = useAuth();
      const navigate = useNavigate();

      const handleChange = (e) => setForm({ ...form, [e.target.name]: e.target.value });
      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        try {
          await axios.post(`${API_BASE}/auth/register`, form);
          const res = await axios.post(`${API_BASE}/auth/login`, { email: form.email, password: form.password });
          login(res.data.accessToken, res.data.refreshToken, 'user');
          navigate('/');
        } catch (err) {
          setError(err.response?.data?.message || 'Xatolik');
        }
      };

      return (
        <PublicRoute>
          <div className="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg mt-10">
            <h2 className="text-2xl font-bold text-center mb-6">Ro'yxatdan o'tish</h2>
            {error && <div className="bg-red-100 text-red-700 p-3 rounded mb-4">{error}</div>}
            <form onSubmit={handleSubmit}>
              <input name="name" placeholder="Ismingiz" className="w-full p-3 border rounded mb-4" value={form.name} onChange={handleChange} required />
              <input name="email" type="email" placeholder="Email" className="w-full p-3 border rounded mb-4" value={form.email} onChange={handleChange} required />
              <input name="password" type="password" placeholder="Parol (6+)" className="w-full p-3 border rounded mb-6" value={form.password} onChange={handleChange} minLength="6" required />
              <button type="submit" className="w-full bg-primary text-white py-3 rounded font-medium">Ro'yxatdan o'tish</button>
            </form>
            <p className="text-center mt-4">
              Hisobingiz bormi? <Link to="/login" className="text-primary">Kirish</Link>
            </p>
          </div>
        </PublicRoute>
      );
    };

    const Login = () => {
      const [form, setForm] = useState({ email: '', password: '' });
      const [error, setError] = useState('');
      const { login } = useAuth();
      const navigate = useNavigate();

      const handleChange = (e) => setForm({ ...form, [e.target.name]: e.target.value });
      const handleSubmit = async (e) => {
        e.preventDefault();
        setError('');
        try {
          const res = await axios.post(`${API_BASE}/auth/login`, form);
          const role = form.email === 'admin@example.com' ? 'admin' : 'user';
          login(res.data.accessToken, res.data.refreshToken, role);
          navigate('/');
        } catch (err) {
          setError(err.response?.data?.message || 'Email yoki parol noto‚Äòg‚Äòri');
        }
      };

      return (
        <PublicRoute>
          <div className="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg mt-10">
            <h2 className="text-2xl font-bold text-center mb-6">Tizimga kirish</h2>
            {error && <div className="bg-red-100 text-red-700 p-3 rounded mb-4">{error}</div>}
            <form onSubmit={handleSubmit}>
              <input name="email" type="email" placeholder="Email" className="w-full p-3 border rounded mb-4" value={form.email} onChange={handleChange} required />
              <input name="password" type="password" placeholder="Parol" className="w-full p-3 border rounded mb-6" value={form.password} onChange={handleChange} required />
              <button type="submit" className="w-full bg-primary text-white py-3 rounded font-medium">Kirish</button>
            </form>
            <p className="text-center mt-4">
              Hisobingiz yo‚Äòqmi? <Link to="/register" className="text-primary">Ro'yxatdan o'tish</Link>
            </p>
          </div>
        </PublicRoute>
      );
    };

    const Products = () => {
      const [products, setProducts] = useState([]);
      const [loading, setLoading] = useState(true);
      const { auth } = useAuth();

      useEffect(() => {
        axios.get(`${API_BASE}/products`).then(res => {
          setProducts(res.data);
          setLoading(false);
        });
      }, []);

      const addToCart = async (productId) => {
        if (!auth) return alert('Iltimos, tizimga kiring!');
        try {
          await axios.post(`${API_BASE}/cart`, { productId, quantity: 1 }, {
            headers: { Authorization: `Bearer ${auth.token}` }
          });
          alert('‚úÖ Savatga qo‚Äòshildi!');
        } catch (err) {
          alert('‚ùå Xatolik');
        }
      };

      if (loading) return <div className="text-center py-12">Yuklanmoqda...</div>;

      return (
        <div className="container mx-auto px-4 py-8">
          <h1 className="text-3xl font-bold mb-8 text-center">Mahsulotlar</h1>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            {products.map(p => (
              <div key={p._id} className="bg-white rounded-xl shadow-md overflow-hidden card-hover">
                <div className="h-48 bg-gray-100 flex items-center justify-center">
                  <i className="fas fa-box-open text-5xl text-gray-400"></i>
                </div>
                <div className="p-4">
                  <h3 className="font-bold text-lg">{p.name}</h3>
                  <p className="text-gray-600 text-sm mb-2 line-clamp-2">{p.description}</p>
                  <div className="flex justify-between items-center">
                    <span className="text-xl font-bold text-accent">${p.price}</span>
                    <button onClick={() => addToCart(p._id)} className="bg-primary text-white p-2 rounded-full">
                      <i className="fas fa-plus"></i>
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    const Cart = () => {
      const [cart, setCart] = useState({ items: [] });
      const [loading, setLoading] = useState(true);
      const { auth } = useAuth();

      useEffect(() => {
        if (!auth) return;
        axios.get(`${API_BASE}/cart`, {
          headers: { Authorization: `Bearer ${auth.token}` }
        }).then(res => {
          setCart(res.data);
          setLoading(false);
        });
      }, [auth]);

      if (loading) return <div className="text-center py-12">Yuklanmoqda...</div>;

      return (
        <div className="container mx-auto px-4 py-8 max-w-4xl">
          <h1 className="text-3xl font-bold mb-8 text-center">Savat</h1>
          {cart.items.length === 0 ? (
            <div className="text-center py-12">
              <i className="fas fa-shopping-cart text-5xl text-gray-300 mb-4"></i>
              <p className="text-xl text-gray-500">Savatingiz bo'sh</p>
              <Link to="/products" className="bg-primary text-white mt-4 inline-block px-6 py-2 rounded">Mahsulotlarni ko'rish</Link>
            </div>
          ) : (
            <div className="space-y-6">
              {cart.items.map((item, i) => (
                <div key={i} className="flex items-center justify-between bg-white p-4 rounded-lg shadow">
                  <div>
                    <p className="font-medium">ID: {item.productId}</p>
                    <p className="text-gray-600">Miqdori: {item.quantity}</p>
                  </div>
                  <button className="text-red-500 hover:text-red-700">
                    <i className="fas fa-trash"></i>
                  </button>
                </div>
              ))}
              <div className="text-right mt-6">
                <button className="bg-accent text-white px-6 py-3 rounded font-medium hover:bg-emerald-700">
                  Buyurtma berish ‚Üí
                </button>
              </div>
            </div>
          )}
        </div>
      );
    };

    const Admin = () => {
      const [products, setProducts] = useState([]);
      const [form, setForm] = useState({ name: '', description: '', price: '', category: '', brand: '' });
      const { auth } = useAuth();

      useEffect(() => {
        if (auth?.role === 'admin') {
          axios.get(`${API_BASE}/products`).then(res => setProducts(res.data));
        }
      }, [auth]);

      const createProduct = async (e) => {
        e.preventDefault();
        try {
          await axios.post(`${API_BASE}/admin/products`, form, {
            headers: { Authorization: `Bearer ${auth.token}` }
          });
          alert('‚úÖ Qo‚Äòshildi!');
          axios.get(`${API_BASE}/products`).then(res => setProducts(res.data));
          setForm({ name: '', description: '', price: '', category: '', brand: '' });
        } catch (err) {
          alert('‚ùå Xatolik');
        }
      };

      const deleteProduct = async (id) => {
        if (!window.confirm('O‚Äòchirmoqchimisiz?')) return;
        try {
          await axios.delete(`${API_BASE}/admin/products/${id}`, {
            headers: { Authorization: `Bearer ${auth.token}` }
          });
          alert('üóëÔ∏è O‚Äòchirildi!');
          axios.get(`${API_BASE}/products`).then(res => setProducts(res.data));
        } catch (err) {
          alert('‚ùå Xatolik');
        }
      };

      if (auth?.role !== 'admin') return <Navigate to="/" />;

      return (
        <div className="container mx-auto px-4 py-6">
          <h1 className="text-3xl font-bold mb-8 text-center">Admin Panel</h1>
          <div className="bg-white p-6 rounded-xl shadow mb-8">
            <h2 className="text-xl font-semibold mb-4">Mahsulot qo'shish</h2>
            <form onSubmit={createProduct} className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <input placeholder="Nomi" className="p-2 border rounded" value={form.name} onChange={e => setForm({...form, name: e.target.value})} required />
              <input placeholder="Kategoriya" className="p-2 border rounded" value={form.category} onChange={e => setForm({...form, category: e.target.value})} required />
              <input placeholder="Brend" className="p-2 border rounded" value={form.brand} onChange={e => setForm({...form, brand: e.target.value})} />
              <input type="number" placeholder="Narxi" className="p-2 border rounded" value={form.price} onChange={e => setForm({...form, price: e.target.value})} required />
              <textarea placeholder="Tavsif" className="p-2 border rounded md:col-span-2" value={form.description} onChange={e => setForm({...form, description: e.target.value})} required />
              <button type="submit" className="bg-primary text-white py-2 rounded md:col-span-2">Qo'shish</button>
            </form>
          </div>
          <div>
            <h2 className="text-2xl font-bold mb-4">Mavjud mahsulotlar ({products.length})</h2>
            {products.map(p => (
              <div key={p._id} className="flex justify-between items-center bg-gray-50 p-3 rounded mb-2">
                <span>{p.name} ‚Äî ${p.price}</span>
                <button onClick={() => deleteProduct(p._id)} className="bg-red-500 text-white px-3 py-1 rounded">O'chirish</button>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // ========== App ==========
    const App = () => (
      <AuthProvider>
        <BrowserRouter>
          <Routes>
            <Route element={<Layout />}>
              <Route index element={<Home />} />
              <Route path="/register" element={<Register />} />
              <Route path="/login" element={<Login />} />
              <Route path="/products" element={<PrivateRoute><Products /></PrivateRoute>} />
              <Route path="/cart" element={<PrivateRoute><Cart /></PrivateRoute>} />
              <Route path="/admin" element={<PrivateRoute adminOnly><Admin /></PrivateRoute>} />
            </Route>
          </Routes>
        </BrowserRouter>
      </AuthProvider>
    );

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>